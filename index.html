<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BART Realtime Boards</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #000;
      --card: #0e0e0e;
      --muted: #a0a6ad;
      --text: #fff;
      --rule: #1a1a1a;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: "Inter", system-ui, sans-serif;
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .wrap { width: min(880px, 92vw); margin: 24px 0; }
    header { display:flex; align-items:center; justify-content:space-between; }
    .title { font-family: "Space Grotesk", Inter, sans-serif; font-size: 1.8rem; font-weight: 600; }
    .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--rule); color: var(--muted); }
    .toolbar { display:flex; gap:10px; align-items:center; margin-top: 10px; color: var(--muted); }
    select, button { background:#111; color:var(--text); border:1px solid var(--rule); border-radius:8px; padding:6px 10px; }
    .board { margin-top:12px; background:var(--card); border:1px solid var(--rule); border-radius:10px; overflow:clip; }
    .row { display:grid; grid-template-columns: 1fr auto auto auto; gap:20px; align-items:center; padding:12px 16px; border-bottom:1px solid var(--rule); }
    .row:last-child{border-bottom:none;}
    .dest{display:flex;align-items:center;gap:10px;}
    .pill{width:16px;height:16px;border-radius:50%;outline:1px solid rgba(255,255,255,.15);outline-offset:-1px;}
    .destination-name{font-family:"Space Grotesk";font-size:1.2rem;font-weight:600;}
    .min{font-variant-numeric:tabular-nums;font-weight:700;font-size:2rem;}
    .min .small{font-weight:400;font-size:.7rem;color:var(--muted);margin-left:4px;}
    .plat,.len{font-size:.8rem;color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="title">Glen Park â†’ Northbound</h1>
      <span class="badge" id="last-updated">â€”</span>
    </header>
    <div class="toolbar">
      <label>Auto-refresh
        <select id="intervalSel">
          <option value="5">5s</option>
          <option value="10" selected>10s</option>
          <option value="15">15s</option>
          <option value="30">30s</option>
        </select>
      </label>
      <button id="refreshBtn">Refresh</button>
      <span id="status" class="notice">Startingâ€¦</span>
    </div>
    <div id="board-north" class="board"></div>
  </div>

  <div class="wrap">
    <header>
      <h1 class="title">Montgomery â†’ Southbound</h1>
      <span class="badge" id="last-updated-south">â€”</span>
    </header>
    <div id="board-south" class="board"></div>
  </div>

  <script>
  const API_KEY = 'MW9S-E7SL-26DU-VV8V';
  const INTERVAL_DEFAULT = 10;

  async function fetchEtd(station, direction, signal){
    const url = `https://api.bart.gov/api/etd.aspx?cmd=etd&orig=${station}&dir=${direction}&key=${API_KEY}&json=y`;
    const res = await fetch(url,{signal});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  function flattenEstimates(json, dir){
    try{
      const st = json.root?.station?.[0];
      const list = st?.etd || [];
      const rows=[];
      list.forEach(item=>{
        (item.estimate||[]).forEach(est=>{
          if((est.direction||'').toLowerCase().startsWith(dir)){
            let minutes = est.minutes;
            if (minutes === 'Leaving') minutes = '0';
            rows.push({destination:item.destination,minutes:minutes,length:est.length,hexcolor:est.hexcolor,bikeflag:est.bikeflag});
          }
        });
      });
      rows.sort((a,b)=>(a.minutes==='0'?-1:b.minutes==='0'?1:(parseInt(a.minutes)||0)-(parseInt(b.minutes)||0)));
      return rows;
    }catch(e){console.error(e);return[];}
  }

  function renderBoard(el,rows){
    if(!rows.length){el.innerHTML='<div class="row">No departures right now.</div>';return;}
    el.innerHTML=rows.map(r=>`
      <div class="row">
        <div class="dest"><span class="pill" style="background:${r.hexcolor||'#888'}"></span><div class="destination-name">${r.destination}</div></div>
        <div class="min">${r.minutes}<span class="small">min</span></div>
        <div class="plat">${r.length? r.length+' cars':''}</div>
        <div class="len">${r.bikeflag==='1'?'ðŸš² ok':''}</div>
      </div>`).join('');
  }

  async function updateBoards(){
    const ctl=new AbortController();
    const timeout=setTimeout(()=>ctl.abort(),8000);
    try{
      const north=await fetchEtd('GLEN','n',ctl.signal);
      const south=await fetchEtd('MONT','s',ctl.signal);
      const northRows=flattenEstimates(north,'n');
      const southRows=flattenEstimates(south,'s');
      renderBoard(document.getElementById('board-north'),northRows);
      renderBoard(document.getElementById('board-south'),southRows);
      document.getElementById('last-updated').textContent=new Date().toLocaleTimeString();
      document.getElementById('last-updated-south').textContent=new Date().toLocaleTimeString();
      document.getElementById('status').textContent='OK';
    }catch(err){
      console.error(err);
      document.getElementById('status').textContent='Error';
    }finally{clearTimeout(timeout);}
  }

  let timerId=setInterval(updateBoards,INTERVAL_DEFAULT*1000);
  document.getElementById('refreshBtn').addEventListener('click',updateBoards);
  document.getElementById('intervalSel').addEventListener('change',e=>{
    clearInterval(timerId);
    timerId=setInterval(updateBoards,parseInt(e.target.value,10)*1000);
  });

  updateBoards();
  </script>
</body>
</html>
